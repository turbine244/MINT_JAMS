<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anchor</title>
    <link rel="stylesheet" href="/css/anchor.css">

    <!--LIB-->
    <script src="https://cdn.zingchart.com/zingchart.min.js"></script>

    <!--ICON-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        .material-symbols-outlined {
            font-size: 1.5rem;
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>

    <!--FONT-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Gasoek+One&family=Jua&family=Monda:wght@400..700&family=Nanum+Brush+Script&family=Nanum+Gothic&family=Noto+Sans+KR:wght@100..900&display=swap"
        rel="stylesheet">
</head>

<body onselectstart='return false'>
    <div id="master">
        <!--HEADER-->
        <div id="header">
            <table id="tbl_header">
                <tr>
                    <td class="c1">
                        <span class="material-symbols-outlined">anchor</span><span class="logo">ANCHOR</span>
                    </td>
                    <td class="c2">
                        <table>
                            <tr>
                                <td id="btn_search" onclick="toggle_search()">
                                    <span class="tool material-symbols-outlined">search</span>
                                </td>
                                <td>
                                    <span class="tool material-symbols-outlined">notifications</span>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

            <div id="msg_notify" class="notify-good">새로운 분석 결과가 있습니다!<br>페이지를 새로고침해주세요.</div>
        </div>

        <!--SEARCH-->
        <div id="search-mask" class="hide"></div>
        <div id="search" class="searchbox pos-abs hide">
            <div class="searchbar">
                <span class="material-symbols-outlined">search</span>
                <form id="form_search" action="#" onsubmit="return false;"
                    onkeydown="if(event.key === 'Enter'){ searchChannelInfo(); }">
                    <input name="channelTitle" id="txt_name_target" type="text" placeholder="Search..." />
                </form>
            </div>

            <div id="search-selector">
                <table id="tbl_selector_search" class="selector">
                    <tr>
                        <td id="sel_search_trending" class="sel now" onclick="toggle_select('search', 'trending')">
                            <table>
                                <tr>
                                    <th></th>
                                </tr>
                                <tr>
                                    <td>인기</td>
                                </tr>
                            </table>
                        </td>
                        <td id="sel_search_recent" class="sel" onclick="toggle_select('search', 'recent')">
                            <table>
                                <tr>
                                    <th></th>
                                </tr>
                                <tr>
                                    <td>최근</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </div>

        </div>

        <!--CONTENT-->
        <div id="content" class="ide">
            <div id="content-result">
                <div id="headline">
                    <span id="headline-targetname">
                    </span>
                    <span id="headline-follow">
                        의 분석 결과를 정리했어요
                    </span>
                </div>


                <div id="chart-selector">
                    <table id="tbl_selector_chart" class="selector">
                        <tr>
                            <td id="sel_chart_wordCloud" class="sel now" onclick="toggle_select('chart', 'wordCloud')">
                                <table>
                                    <tr>
                                        <th></th>
                                    </tr>
                                    <tr>
                                        <td>전체</td>
                                    </tr>
                                </table>
                            </td>
                            <td id="sel_chart_pieChart" class="sel" onclick="toggle_select('chart', 'pieChart')">
                                <table>
                                    <tr>
                                        <th></th>
                                    </tr>
                                    <tr>
                                        <td>코멘트 중심</td>
                                    </tr>
                                </table>
                            </td>
                            <td id="sel_chart_details" class="sel" onclick="toggle_select('chart', 'log')">
                                <table>
                                    <tr>
                                        <th></th>
                                    </tr>
                                    <tr>
                                        <td>분석 상세</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
                <div id="chart-area">
                    <div id="wordCloud"></div>
                </div>
            </div>

            <div id="channel-card">
                <table id="tbl_channel">
                    <tr>
                        <td>
                            <div id="channel-thumbnail">
                                <div id="channel-progress-mask"></div>
                                <div id="channel-progress"></div>
                                <div id="channel-halo"></div>
                                <div id="channel-image"></div>
                                <div id="channel-numplate">7/10</div>
                            </div>

                        </td>
                        <td>
                            <table id="info-anchor" class="tbl_info">
                                <tr>
                                    <th>채널 ID
                                        <span class="material-symbols-outlined"
                                            style="font-size: 0.6rem; opacity: 0.4;;">
                                            open_in_browser
                                        </span>
                                    </th>
                                    <td id="txt_channel_id">@ABCDEF</td>
                                </tr>
                                <tr>
                                    <th>최초 발견</th>
                                    <td id="ymd_found_first">2024/12/12</td>
                                </tr>
                                <tr>
                                    <th>최근 발견</th>
                                    <td id="txt_found_last">23시간 59분 전</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <!--FOOTER-->
        <div id="footer">
            <div id="sky-area">
                <div id="msg_footer">
                    궁금한 인물 정보는,<br>제일 먼저 ANCHOR에서
                </div>
            </div>
            <div id="sea-area">
                <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                    viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
                    <defs>
                        <path id="gentle-wave"
                            d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
                    </defs>
                    <g class="parallax">
                        <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(41,53,71,0.7" />
                        <use xlink:href="#gentle-wave" x="48" y="3" fill="rgba(41,53,71,0.5)" />
                        <use xlink:href="#gentle-wave" x="48" y="5" fill="rgba(41,53,71,0.3)" />
                        <use xlink:href="#gentle-wave" x="48" y="7" fill="rgba(41,53,71,1.0)" />
                    </g>
                </svg>
                <div id="log-area"></div>
            </div>
        </div>
    </div>

    <!--MAIN-->
    <script>
        // 페이지 로드 시 초기화
        document.addEventListener("DOMContentLoaded", () => {
            //setupNavigationButtons();
        });

        function showLoading() {
            //document.getElementById("loadingIndicator").style.display = "block";
        }

        function hideLoading() {
            //document.getElementById("loadingIndicator").style.display = "none";
        }

        let channelId = null;  // 채널 ID를 전역 변수로 선언

        function searchChannel() {
            const channelTitle = document.getElementById("txt_name_target").value;
            if (!channelTitle) {
                alert("채널 제목을 입력하세요.");
                return;
            }

            // 검색 후 페이지 새로 고침 없이 데이터 로드
            window.location.href = `/search?channelTitle=${encodeURIComponent(channelTitle)}`;
        }



        // 주기적으로 차트만 갱신하는 함수
        function updateCharts() {
            if (channelId) {
                loadWordCloud(channelId);
                //loadRankChart(channelId);
                //loadPieChartData(channelId); // 이 함수가 호출되었는지 확인
            } else {
                console.log("channelId is not set");
            }
        }

        // URL에서 channelTitle을 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const channelTitle = urlParams.get('channelTitle');

        if (channelTitle) {
            console.log("Received channelTitle:", channelTitle);
            // 데이터를 로드하는 함수 호출 가능
            searchChannelInfo(channelTitle);

            // 일정 간격(예: 5초)으로 차트 갱신
            setInterval(() => {
                updateCharts(channelId);
            }, 5000); // 5000ms = 5초마다 차트 갱신

        } else {
            alert("채널 제목이 없습니다.");
        }

        async function fetchData(endpoint, params) {
            showLoading(); // 로딩 메시지 표시
            const queryString = new URLSearchParams(params).toString();
            try {
                const response = await fetch(`/api/${endpoint}?${queryString}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return response.json();
            } catch (error) {
                console.error("Error while fetching data:", error);
                throw error;
            } finally {
                hideLoading(); // 로딩 메시지 숨김
            }
        }

        async function searchChannelInfo(channelTitle) {
            if (!channelTitle) return;

            showLoading();
            try {
                const channelData = await fetchData("channel", { channelTitle });
                drawChannelCard(channelData);
                channelId = channelData.channelId; // 여기서 설정됨
                console.log("Channel ID:", channelId); // 확인용 로그
                updateCharts();
            } catch (error) {
                console.error("Error while fetching data: ", error);
            } finally {
                hideLoading();
            }
        }

        function drawChannelCard(data) {
            document.getElementById('headline-targetname').innerText = data.channelTitle;
            //document.getElementById('txt_link_channel').innerText = data.channelUrl;
            //document.getElementById('ymd_creation_channel').innerText = data.createdAt;
            //document.getElementById('txt_subscriber').innerText = data.subscriberCount;
            //document.getElementById('num_content').innerText = data.contentNum;

            const temp = document.getElementById('channel-image');
            temp.style.backgroundImage = `url('${data.channelThumbnail}')`;  // 썸네일 이미지 설정
            temp.style.backgroundSize = "cover";  // 이미지가 요소를 채우도록 설정
            temp.style.backgroundPosition = "center";  // 이미지 가운데 정렬

            document.getElementById('ymd_found_first').innerText = data.createdAtDB;  // 최초 발견 일자
            document.getElementById('txt_found_last').innerText = data.updatedAt;    // 마지막 발견
            //document.getElementById('num_anchorer').innerText = data.anchorNum;       // ANCHOR

        }


        function drawWordCloud(data, labels) {
            // 워드클라우드 모듈 불러오기
            zingchart.MODULESDIR = 'https://cdn.zingchart.com/modules/';

            // 워드 클라우드를 그릴 데이터 형식 준비
            var wordset = [];
            for (var i = 0; i < data.length; i++) {
                wordset.push({ text: labels[i], count: data[i] });
            }

            // 워드클라우드 환경설정
            var myConfig = {
                type: 'wordcloud',
                options: {
                    words: wordset,
                    minLength: 5, // 최소 길이
                    ignore: [""], // 빈 문자열을 무시
                    maxItems: 100, // 최대 항목 수
                    aspect: 'spiral', // 단어 배치 방식
                    colorType: 'palette',
                    palette: ['#D32F2F', '#5D4037', '#1976D2', '#E53935', '#6D4C41', '#1E88E5', '#F44336', '#795548', '#2196F3', '#EF5350', '#8D6E63', '#42A5F5'],
                    style: {
                        fontFamily: 'Crete Round',
                        hoverState: {
                            backgroundColor: '#D32F2F',
                            borderRadius: 2,
                            fontColor: 'white'
                        },
                        tooltip: {
                            text: '%text: %hits', // 툴팁 내용
                            visible: true,
                            alpha: 0.9,
                            backgroundColor: '#1976D2',
                            borderRadius: 2,
                            fontColor: 'white',
                            fontFamily: 'Georgia',
                            textAlpha: 1
                        }
                    }
                },
                source: {
                    fontColor: '#64B5F6',
                    fontSize: 10,
                    fontFamily: 'Georgia',
                    fontWeight: 'normal',
                    marginBottom: '10%'
                }
            };

            // 워드클라우드 렌더링
            zingchart.render({
                id: 'wordCloud', // `wordCloud`는 HTML의 id로 설정
                data: myConfig,
                height: '100%',
                width: '100%'
            });

            document.getElementById('headline-targetname').innerText = "aaaa"
        }

        async function loadWordCloud(channelId) {
            const data = await fetchData("wordcloud", { channelId });
            drawWordCloud(data.foundList, data.keyList);
        }


    </script>

    <!--FDEF : NOTIFY-->
    <script>
        function notify(message, isGood) {
            let id = document.getElementById("msg_notify");
            id.innerText = message;

            id.classList.remove("notify-good");
            id.classList.remove("notify-bad");

            if (isGood) {
                notify.classList.add("notify-good");
            }
            else {
                notify.classList.add("notify-bad");
            }
        }
    </script>

    <!--FDEF : TOGGLE SEARCH-->
    <script>
        function toggle_search() {
            let id;

            id = document.getElementById('search');
            id.classList.toggle("hide");

            id = document.getElementById('search-mask');
            id.classList.toggle("hide");
        }
    </script>

    <!--FDEF : TOGGLE SELECT-->
    <script>
        function toggle_select(category, val) {
            let id_sel;

            if (category == 'search') {
                id_sel = document.getElementById('sel_search_recent');
                id_sel.classList.remove("now");
                id_sel = document.getElementById('sel_search_trending');
                id_sel.classList.remove("now");
            }
            else {
                id_sel = document.getElementById('sel_chart_wordCloud');
                id_sel.classList.remove("now");
                id_sel = document.getElementById('sel_chart_pieChart');
                id_sel.classList.remove("now");
                id_sel = document.getElementById('sel_chart_details');
                id_sel.classList.remove("now");
            }

            id_sel = document.getElementById('sel_' + category + '_' + val);
            id_sel.classList.add("now");
        }
    </script>

    <!--FDEF : WORDCLOUD; DRAW, LOAD-->
    <script>
    </script>

    <!--FDEF : DRAW PIE-CHART-->
    <script>
    </script>

    <!--FDEF : DRAW DETAILS-->
    <script>
    </script>

</body>

</html>